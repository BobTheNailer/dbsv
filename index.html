<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/db.css"/>
    <title>SizeViewer</title>
</head>
<body>
<header>
    <div class="toolbar">
        <button id="run" style="display: none">Pause</button>
        <span id="wtr">Waiting for ...</span>
    </div>
    <div class="userInfo">
        <span id="userName"></span>
        <button id="singOut" style="display: none">Sing out</button>
    </div>
</header>
<section id="topscreen">
    <div>
        <ul>
            <li class="row">
                <div class="about">
                    <img src="https://raw2.github.com/artzub/dbsv/master/favicon.png" class="icon" style="width: 122px"/>
                    <div>
                        <h1>SizeViewer</h1>
                        <p>
                            <br/>
                            Service to view the used file space in a cloud file storage.
                            <hr/>
                            Powered by <a href="http://d3js.org">D3.js</a>.<br/>
                            Created by <a href="http://artzub.com">Artem Zubkov</a>.
                        </p>
                    </div>
                </div>
            </li>
            <li><a href="?cloud=db"><img src="https://raw2.github.com/artzub/dbsv/master/images/db.ico" alt="Dropbox"/><h1>DropBox</h1></a></li>
            <li><a href="?cloud=gd"><img src="https://raw2.github.com/artzub/dbsv/master/images/gd.ico" alt="GoogleDrive"/><h1>Google Drive</h1></a></li>
            <li><a href="?cloud=yad"><img src="https://raw2.github.com/artzub/dbsv/master/images/yad.png" alt="YandexDisk"/><h1>Yandex Disk</h1></a></li>
            <li class="row" style="text-align: center"><span id="hidets" style="display: none">Close</span></li>
        </ul>
    </div>
    <span id="showts">about</span>
</section>
<section id="canvas"></section>

<script src="//rawgithub.com/mbostock/d3/master/d3.min.js" charset="utf-8"></script>
<script src="//rawgithub.com/artzub/dbsv/master/js/tooltip.js" charset="utf-8"></script>
<script src="//rawgithub.com/artzub/dbsv/master/js/progressbar.js" charset="utf-8"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js"></script>
<script src="//rawgithub.com/artzub/JSONP/master/JSONP.js" charset="utf-8"></script>
<script src="//rawgithub.com/artzub/dbsv/master/js/environment.js"></script>
<script src="//rawgithub.com/artzub/dbsv/master/js/loader.js"></script>

<script>
    'use strict';

    var yakey = "284cdcf7b84346e39b7982985649b689";

    var dbkey = "hf2l7lg3omgwze7";

    var gakey = "601600490264-mtpipnm40ojl25ki9flt12arrqlnhm4d.apps.googleusercontent.com";

    var DEBUG = false;

    var redirectUrl = DEBUG
            ? "http://localhost:63342/dbsv/index.html"
            : "https://artzub.com/d3/dbsv/?cloud=db";

    var PI2 = Math.PI * 2,
        sizes = {
            bytes : 1,
            KB : 1024
        }
    ;

    sizes.MB = sizes.KB * 1024;
    sizes.GB = sizes.MB * 1024;
    sizes.TB = sizes.GB * 1024;
    sizes.PB = sizes.TB * 1024;

    var dirTree = {}
            , dirTreeDraw = {}
            , requestTurn = []
            , params = {}
            , selected
            , doStart
            , loopSnd
            , to = 10
            ;
    var client;


    var option = {
        incBar : prgInc,
        setMaxBar : prgMax,
        getMaxBar : prgMax,
        onBeginWaiting : showWaiter,
        onEndWaiting : hideWaiter,
        onWork : function(data) {
            calc(data);
        },
        onSingIn : function(data) {
            d3.select("#singOut")
                .style("display", null)
                .on("click", client.singOut);
            d3.select("#userName")
                .text(data.name)
        },
        onSingOut : function() {
            d3.select("#singOut")
                    .style("display", "none");
            d3.select("#userName")
                    .text("");
        },
        startImmediately : true
    };

    function prgInc() {
        progress.step()
                .label(progress.pos() + " of " + progress.max());
    }

    function prgMax(max) {
        if (arguments.length < 1)
            return progress.max();
        progress.max(max);
        return max;
    }

    document.location.search.replace("?", "").split("&").forEach(function(d) {
        d = d.split('=');
        params[d[0]] = d[1];
    });

    option.root = params.root;

    function hideStart() {
        progress.style("display", null);
        d3.select("#topscreen").classed("hide", true);
        hideWaiter();
    }

    function init() {
        d3.select("#wtr").style("display", "none");
        progress.style("display", "none");

        if (params.cloud == "db") {
            hideStart();
            client = DropBoxClient(option);
            client.singIn(dbkey, redirectUrl);
        }
        else if (params.cloud == 'yad') {
            hideStart();
            client = YandexDiskClient(option);
            client.singIn(yakey);
        }
        else if (params.cloud == 'gd') {
            hideStart();
            GoogleDriveClient(function() {
                client = GoogleDriveClient(option);
                client.singIn(gakey);
            });
        }
    }

    // http://bl.ocks.org/mbostock/4348373

    var w = window.innerWidth,
        h = window.innerHeight,
        radius,
        path;

    d3.select("#run").on("click", function() {
        client.isPaused() ? client.resume() : client.pause();
        this.innerText = client.isPaused() ? "Start" : "Pause";
    });

    function showWaiter() {
        d3.select("#run").style("display", "none");
        d3.select("#wtr").style("display", null);
    }

    function hideWaiter() {
        d3.select("#run").style("display", null);
        d3.select("#wtr").style("display", "none");
    }

    var color = d3.scale.category20c();

    var svg = d3.select("#canvas").append("svg")
            .attr("width", w)
            .attr("height", h);

    var progress = svg.append("g")
        .call(d3.helper.progressbar)
        .width(w)
    ;

    progress.textPosition("middle")
        .attr("transform", "translate(" + [0, h - progress.height()] + ")");

    function resize() {
        w = window.innerWidth;
        h = window.innerHeight;

        svg.attr("width", w)
           .attr("height", h);
        progress.width(w)
                .attr("transform", "translate(" + [0, h - progress.height()] + ")");
        radius = Math.min(w, h - progress.height() - 10) / 2;
        y.range([0, radius]);
        group.attr("transform", "translate(" + [(w / 2), ((h - progress.height() - 10) / 2) + 5] + ")");
        if (client && client.getDirTree)
            calc(client.getDirTree());
    }

    d3.select(window).on("resize", resize);

    radius = Math.min(w, h - progress.height() - 10) / 2;

    var x = d3.scale.linear()
            .range([0, PI2]);

    var y = d3.scale.sqrt()
            .range([0, radius]);

    var group = svg.append("g")
            .attr("transform", "translate(" + [(w / 2), ((h - progress.height() - 10) / 2) + 5] + ")");

    var partition = d3.layout.partition()
            .value(function(d) { return d.size || 0; });

    function calc(data) {
        if (!loopSnd) {
            var clone = JSON.parse(JSON.stringify(data));
            loopSnd = setTimeout(function() {

                dirTreeDraw = partition(clone).filter(filter);
                update();
                loopSnd = null;
            }, to);
        }
    }

    var arc = d3.svg.arc()
        .startAngle(function(d) { return Math.max(0, Math.min(PI2, x(d.x))); })
        .endAngle(function(d) { return Math.max(0, Math.min(PI2, x(d.x + d.dx))); })
        .innerRadius(function(d) { return Math.max(0, y(d.y)); })
        .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

    var tf = d3.format('.2f');

    function formatSize(d) {
        var s = sizes.B,
            af = " B";

        if (d < sizes.MB) {
            s = sizes.KB;
            af = " KB";
        }
        else if (d < sizes.GB) {
            s = sizes.MB;
            af = " MB";
        }
        else if (d < sizes.TB) {
            s = sizes.GB;
            af = " GB";
        }
        else if (d < sizes.PB) {
            s = sizes.TB;
            af = " TB";
        }
        else if (d > sizes.PB) {
            s = sizes.PB;
            af = " PB";
        }

        return tf((d/s) || 0) + af;
    }

    var tooltip = d3.helper.tooltip()
        .padding(16)
        .spaceWidth(w)
        .spaceHeight(h)
        .text(function(d) {
            var img = [];
            switch (params.cloud) {
                case "db":
                    img = [
                        "<img src='https://www.dropbox.com/static/images/icons/icon_spacer.gif' class='",
                        d.icon,
                        "'>"
                    ];
                    break;
                case "gd":
                    img = [
                        "<img src='",
                        d.icon,
                        "' class='icon'>"
                    ];
                    break;
            }
            return [
                img.join(""),
                "<div style='overflow: hidden'>Name: <b>",
                d.name,
                "</b><br/>Path: <b>",
                d.path,
                "</b><br/>Size: <b>",
                formatSize(d.value),
                d.type && d.type.length > 0 ? "</b><br/>MimeType: <b>" : "",
                d.type,
                "</b><br/></div>"
            ].join("")
        })
    ;
    function toRgba(c, a) {
        c = d3.rgb(c);
        return "rgba(" + [c.r, c.g, c.b, a] + ")";
    }

    function fill(d) {
        var k = (d.children ? d : d.parent).path;
        return d.path == "/.FreeSpace" ? toRgba("#444", .1) : color(k);
    }

    function disSet(d) {
        return filter(d) ? null : "none";
    }

    function key(d) {
        return d.seqid;
    }

    function filter(d) {
        return !selected || (
            d.seqid == selected.seqid ||
            (selected.parent && (d.seqid == selected.parent.seqid || (
                selected.parent.parent && d.seqid == selected.parent.parent.seqid)
            )) ||
            d.path.indexOf(selected.path) == 0
        );
    }

    function update() {
        path = group.selectAll("path")
            .data(dirTreeDraw.filter(filter), key);

        path.enter()
            .append("path")
            .style({
                fill: fill
            })
            .call(tooltip)
            .filter(function(d) {
                return d.isDir;
            })
            .on("click", click)
            .attr("class", "isdir")
        ;

        path.exit().remove();

        path.attr("d", arc);
    }

    function click(d) {
        path.transition()
            .duration(750)
            .attrTween("d", arcTween(d))
            .each("end", function() {
                calc(client.getDirTree());
            })
        ;
    }

    function hidets() {
        d3.select("#topscreen").classed("hide", true);
    }

    d3.select("#showts").on("click", function() {
        d3.select("#topscreen").classed("hide", false);
        d3.select("#hidets").style("display", null).on("click", hidets);
    });

    // Interpolate the scales!
    function arcTween(d) {
        var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                yd = d3.interpolate(y.domain(), [d.y, 1]),
                yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
        selected = d;
        if (d.seqid == -2)
            selected = null;
        return function(d, i) {
            return i
                    ? function(t) { return arc(d); }
                    : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
        };
    }

    init();

</script>
