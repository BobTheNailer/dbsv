<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="style.css">
    <title>SizeViewer</title>
</head>
<body>
<header>
    <div class="toolbar">
        <button id="run">Pause</button>
        <span id="wtr">Waiting for reset of requests limit. In 3 seconds ...</span>
    </div>
    <div class="userInfo">
        <span id="userName"></span>
        <button id="singOut" style="display: none">Sing out</button>
    </div>
</header>
<section id="canvas"></section>

<script src="//rawgithub.com/mbostock/d3/master/d3.min.js" charset="utf-8"></script>
<script src="tooltip.js" charset="utf-8"></script>
<script src="progressbar.js" charset="utf-8"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js"></script>
<script>
    'use strict';

    var DEBUG = false;

    var redirectUrl = DEBUG
            ? "http://localhost:63342/dbsv/index.html"
            : "https://artzub.com/d3/dbsv";

    var PI2 = Math.PI * 2,
        sizes = {
            bytes : 1,
            KB : 1024
        }
    ;

    sizes.MB = sizes.KB * 1024;
    sizes.GB = sizes.MB * 1024;
    sizes.TB = sizes.GB * 1024;
    sizes.PB = sizes.TB * 1024;

    var dirTree = {}
            , dirTreeDraw = {}
            , requestTurn = []
            , params = {}
            , selected
            , doStart
            , pause
            , loop
            , loopSnd
            , loopThr
            , to = 10
            , seq = 0
            ;

    function logError(error) {
        log("error", error);
    }

    function prgInc() {
        progress.step()
                .label(progress.pos() + " of " + progress.max());
    }

    function prgMax(max) {
        progress.max(progress.max() + max);
    }

    function log(label, data) {
        if (arguments.length < 2)
            console.log(label);
        else
            console.log(label, data);
    }

    hideWaiter();

    document.location.hash.replace("#", "").split("&").forEach(function(d) {
        d = d.split('=');
        params[d[0]] = d[1];
    });

    function init() {

        var client = new Dropbox.Client({
            key: "7b49k68tq0ph77g",
            rememberUser: true
        });

        client.authDriver(new Dropbox.AuthDriver.Redirect({
            receiverUrl: redirectUrl
        }));

        client.authenticate(function(error, client) {
            if (error) {
                log("authError", error);
                return;
            }

            getUserInfo(client);
        });


        function getUserInfo(client) {
            client.getUserInfo(parseUserInfo);
        }

        function parseUserInfo(error, data) {
            if (error) {
                logError(error);
                return;
            }

            d3.select("#singOut")
                    .style("display", null)
                    .on("click", singOut);
            d3.select("#userName")
                    .text(data.name);

            params.root = decodeURIComponent(params.root || "/");

            selected = dirTree = {
                name : "",
                path : params.root,
                children : [],
                level : 0,
                is_dir : true,
                size : data.quota
            };

            if (params.root == "/")
                dirTree.children = [{
                    name : "Free Space",
                    path : "/.FreeSpace",
                    size : data.quota - data.usedQuota,
                    level : 1
                }];

            progress.max(0);

            getData(params.root, dirTree);
        }

        function appendToRT(item) {
            item && (item.f.seqid = (++seq)) && requestTurn.push(item);
            if (pause || loop)
                return;
            loop = setTimeout(function run() {
                var d = !pause;

                d && (d = requestTurn.shift());

                if (d) {
                    getData(d.path, d.f);
                    loop = setTimeout(run, to);
                }
                else {
                    clearTimeout(loop);
                    loop = null;
                }
            }, to);
        }

        function insertDataBack(dir) {
            requestTurn.splice(0, 0, {path : dir.path, f : dir});
            requestTurn.sort(function(a, b) {
                    return d3.ascending(a.f.seqid, b.f.seqid);
            });
        }

        doStart = appendToRT;

        function getData(path, dir) {
            client.metadata(path, {readDir : true}, parseDirInfo(dir));
        }

        function getName(path) {
            return path.substr(path.lastIndexOf("/") + 1);
        }

        function analyseDirInfo(dir) {
            if (!dir.children)
                dir.children = [];

            return function(d) {
                var f = {
                    name : getName(d.path),
                    path : d.path,
                    level : dir.level + 1,
                    is_dir : d.is_dir
                };

                if (d.is_dir) {
                    appendToRT({path : d.path, f : f});
                }
                else {
                    prgInc();
                    f.orignsize = d.size || 0;
                    f.size = d.bytes || 0;
                }
                dir.children.push(f);
                calc(dirTree);
            }
        }

        function resetWaiting() {
            if (loopThr) {
                clearTimeout(loopThr);
                loopThr = null;
            }
            showWaiter();
            loopThr = setTimeout(function(){
                pause = false;
                hideWaiter();
                appendToRT();
                loopThr = null;
            }, 3000);
        }

        function parseDirInfo(dir) {
            return function(error, data) {
                if (error) {
                    //send error
                    if (error.status == 429) {
                        pause = true;
                        insertDataBack(dir);
                        resetWaiting();
                    }
                    logError(error);
                    return;
                }

                //move progress bar
                prgMax(data._json.contents.length);

                data._json.contents
                && data._json.contents.forEach(analyseDirInfo(dir));

                //inc position progress bar
                prgInc();
            }
        }

        function convertSize(size) {
            var a = size.split(" ");
            return a[0] * sizes[a[1]];
        }

        function singOut() {
            client.signOut(function(error) {
                if (error) {
                    log("error", error);
                    return;
                }
                d3.select("#singOut")
                    .style("display", "none");
                d3.select("#userName")
                    .text("");
            });
        }
    }

    init();

    // http://bl.ocks.org/mbostock/4348373

    var w = window.innerWidth,
        h = window.innerHeight,
        radius,
        path;

    d3.select("#run").on("click", function() {
        pause = !pause;
        this.innerText = pause ? "Start" : "Pause";
        !pause && doStart && doStart();
    });

    function showWaiter() {
        d3.select("#run").style("display", "none");
        d3.select("#wtr").style("display", null);
    }

    function hideWaiter() {
        d3.select("#run").style("display", null);
        d3.select("#wtr").style("display", "none");
    }

    var color = d3.scale.category20c();

    var svg = d3.select("#canvas").append("svg")
            .attr("width", w)
            .attr("height", h);

    var progress = svg.append("g")
        .call(d3.helper.progressbar)
        .width(w)
    ;
    progress.textPosition("middle")
        .attr("transform", "translate(" + [0, h - progress.height()] + ")");

    radius = Math.min(w, h - progress.height() - 10) / 2;

    var x = d3.scale.linear()
            .range([0, PI2]);

    var y = d3.scale.sqrt()
            .range([0, radius]);

    svg = svg.append("g")
            .attr("transform", "translate(" + [(w / 2), ((h - progress.height() - 10) / 2) + 5] + ")");

    var partition = d3.layout.partition()
            .value(function(d) { return d.size || 0; });

    function calc(data) {
        if (!loopSnd) {
            var clone = JSON.parse(JSON.stringify(data));
            loopSnd = setTimeout(function() {
                dirTreeDraw = partition(clone).filter(filter);
                update();
                loopSnd = null;
            }, to);
        }
    }

    var arc = d3.svg.arc()
        .startAngle(function(d) { return Math.max(0, Math.min(PI2, x(d.x))); })
        .endAngle(function(d) { return Math.max(0, Math.min(PI2, x(d.x + d.dx))); })
        .innerRadius(function(d) { return Math.max(0, y(d.y)); })
        .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

    var tf = d3.format('.2f');

    function formatSize(d) {
        var s = sizes.B,
            af = " B";

        if (d < sizes.MB) {
            s = sizes.KB;
            af = " KB";
        }
        else if (d < sizes.GB) {
            s = sizes.MB;
            af = " MB";
        }
        else if (d < sizes.TB) {
            s = sizes.GB;
            af = " GB";
        }
        else if (d < sizes.PB) {
            s = sizes.TB;
            af = " TB";
        }
        else if (d > sizes.PB) {
            s = sizes.PB;
            af = " PB";
        }

        return tf((d/s) || 0) + af;
    }

    var tooltip = d3.helper.tooltip()
        .padding(16)
        .spaceWidth(w)
        .spaceHeight(h)
        .text(function(d) {
            return [
                "Name: <b>",
                d.name,
                "</b><br/>Path: <b>",
                d.path,
                "</b><br/>Size: <b>",
                formatSize(d.value),
                "</b><br/>"
            ].join("")
        })
    ;
    function toRgba(c, a) {
        c = d3.rgb(c);
        return "rgba(" + [c.r, c.g, c.b, a] + ")";
    }

    function fill(d) {
        var k = (d.children ? d : d.parent).path;
        return d.path == "/.FreeSpace" ? toRgba("#444", .1) : color(k);
    }

    function key(d) {
        return d.path;
    }

    function filter(d) {
        return true;
    }

    function update() {
        path = svg.selectAll("path")
            .data(dirTreeDraw, key);

        var paths = path.enter()
            .append("path")
            .style("fill", fill)
            .call(tooltip)
            .filter(function(d) {
                return d.is_dir;
            })
            .on("click", click)
            .attr("class", "isdir")
            ;

        path.exit().remove();

        path.attr("d", arc);
    }

    function click(d) {
        path.transition()
            .duration(750)
            .attrTween("d", arcTween(d))
            .each("end", function() {
                calc(dirTree);
            });
    }

    // Interpolate the scales!
    function arcTween(d) {
        var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                yd = d3.interpolate(y.domain(), [d.y, 1]),
                yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
        selected = d;
        return function(d, i) {
            return i
                    ? function(t) { return arc(d); }
                    : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
        };
    }

</script>
